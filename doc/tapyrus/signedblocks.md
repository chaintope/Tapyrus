Signed-Blocks Specification
===========================

Tapyrus uses Signed-Blocks as the block creation algorithm. Signed Blocks is based on Federated Block signing in a Strong Federation which is proposed in [Strong Federations: An Interoperable Blockchain Solution to Centralized Third Party Risks](https://arxiv.org/pdf/1612.05491v2.pdf).

In a Tapryus network, each federation member can run a Tapyrus-signer node to form the tapyrus-signer network. The blocks are poroposed in round-robin by a federation member. If the block succeeds in collecting a minimum of 'thresholdâ€˜ signatures from other federation members, it is added as the next block. The block can be verified by all public nodes running tapyrus-core.

Block Structure Expansion for Signed-Blocks
===========================================

Tapyrus block header has three new fields: xfieldType, xfield and proof. Some fields like bits and nonce are removed. So, Tapyrus block header structure is like this.

 Name | Type | Size(Bytes) | Description
------|------|-------------|-------------
features | int32_t | 4 | Block features. Currently it is required to be 1.
hasPrevBlock | char\[32\] | 32 | 256-bit hash of the previous block header
hashMerkleRoot | char\[32\] | 32 | 256-bit MerkleRoot based on the hashes of all the transactions in the block
hashImMerkleRoot | char\[32\] | 32 | 256-bit MerkleRoot based on Tapyrus transaction id -  [Malleability fixing transaction hash](doc/fix_transaction_malleability.md)
time | uint32_t | 4 | Current block timestamp as seconds since 1970-01-01T00:00 UTC
xfieldType| uint8_t | 1 | Type of xfield. See xfieldType table.
xfield| specified by xfieldType | variable | Extra field. This field can host any type of data defined in Tapyrus protocol.
Proof | char[64] | 65* | Threshold signature generated by tapyrus-signer to validate/approve this block. This fields is empty before the block is approved.

* *Additional 1 byte for length

**xfieldType**

Value | Name|Type|Size(Bytes)|Description
------|-----|----|-----------|------------
0x00 | None | N/A | 0 | set when xfield isn't used.
0x01 | AggregatePublicKey | char[33] | 34* | Aggregate public key of tapyrus-signer used to verify block proof.
0x02 | MaxBlockSize | uint32_t | 4 | Max block size xfield parameter to change the block size in a tapyrus networrk.

* when xfieldType is not 0, xfield is encoded according to the type of data it contains.
- aggregate public key is a vector of char i.e the length and value are encoded. length uses variable length "varint" encoding.
- max block size is an integer i.e 4 byte little endian encoding.

**Aggregate public key**
Tapyrus-core needs an aggregate public key to verify the threshold signature in blocks. 
It reads the aggregate public key from the *genesis block file* named `genesis.dat` found in the data directory. 
The aggregate public key is generated by tapyrus-signer network during network initialization. 
The process involves creation of genesis block using tapyrus-genesis utility and 
starting the tapyrus-signer network to *sign* the genesis block. 
Genesis Block header also has the aggregate public key in xfield. Thus the aggregated public key is embedded into the chain.Tapyrus Core allows the xfield parameters like aggregate public key to be updated when there is a change in the federation controlling tapyrus signer network.

**Maximum block size**
Tapyrus-core has a default block size of 1MB which is inherited from Bitcoin. However increasing the block size can help a tapyrus network achieve better performance. This is possible using xfield MaxBlockSize. The new block size is a four byte unsigned integer. After it is set in the block header and the block is accepted, tapyrus nodes start creating blocks with size upto but not exceeding the maxblocksize.

**XField Persistance**
In order to persist this xfield change, it is stored in the block tree database in level db.

| Key  | Value |
|------|-------|
| 1     | \<n\>\<agg_pub_key_1\>\<height_1\>\<block_hash_1\>\<agg_pub_key_2\>\<height_2\>\<block_hash_2\>...\<agg_pub_key_n\>\<height_n\>\<block_hash_n\>|
| 2     | \<n\>\<max_block_size_1\>\<height_1\>\<block_hash_1\>\<max_block_size_2\>\<height_2\>\<block_hash_2\>...\<max_block_size_n\>\<height_n\>\<block_hash_n\>|

| Field  | Type | Length | Default serialization |
|--------|------|--------|------------|
|n | varint | 1 - 5 bytes| little endian |
|agg_pub_key| vector of char | 1 + 33 | 1 byte length + 33 bytes pubkey |
|max_block_size| unsigned 32 bit integer | 4 | little endian |
|height | unsigned 32 bit integer| 4 | little endian |
|block_hash | unsigned 256 bit integer | 32 | little endian |

**Proof**
Proof is the Schnorr threshold signature generated by the tapyrus-signer network by aggregating the individual signatures of its federation members using a verifiable secret sharing scheme. Details about the scheme are available in [tapyrus-signer](https://github.com/chaintope/tapyrus-signer).

RPC collection for Signer Nodes
===============================

Tapyrus-Signer Nodes use the following RPCs to communicate with Tapyrus-Core.

## getnewblock

```
getnewblock

Gets hex representation of a proposed, unmined new block

Arguments:
1. address         (string, required) The address to send fees and the newly generated coin.
2. required_age    (numeric, optional, default=0) How many seconds a transaction must have been in the mempool to be inluded in the block proposal. This may help with faster block convergence among functionaries using compact blocks.

Result
blockhex      (hex) The block hex

Examples:
> tapyrus-cli getnewblock
```


## submitblock


```
submitblock "hexdata"  ( "dummy" )

Attempts to submit new block to network.
See https://en.bitcoin.it/wiki/BIP_0022 for full specification.

Arguments
1. "hexdata"        (string, required) the hex-encoded block data to submit
2. "dummy"          (optional) dummy value, for compatibility with BIP22. This value is ignored.

Result:

Examples:
> tapyrus-cli submitblock "mydata"
> curl --user myusername --data-binary '{"jsonrpc": "1.0", "id":"curltest", "method": "submitblock", "params": ["mydata"] }' -H 'content-type: text/plain;' http://127.0.0.1:2377/
```
