Signed-Blocks Specification
===========================

Tapyrus uses Signed-Blocks as the block creation algorithm. Signed Blocks is based on Federated Block signing in a Strong Federation which is proposed in [Strong Federations: An Interoperable Blockchain Solution to Centralized Third Party Risks](https://arxiv.org/pdf/1612.05491v2.pdf).

In a Tapryus network, each federation member can run a Tapyrus-signer node to form the tapyrus-signer network. The blocks are poroposed in round-robin by a federation member. If the block succeeds in collecting a minimum of 'thresholdâ€˜ signatures from other federation members, it is added as the next block. The block can be verified by all public nodes running tapyrus-core.

Block Structure Expansion for Signed-Blocks
===========================================

Tapyrus block header has three new fields: xfieldType, xfield and proof. Some fields like bits and nonce are removed. So, Tapyrus block header structure is like this.

 Name | Type | Size(Bytes) | Description
------|------|-------------|-------------
features | int32_t | 4 | Block features. Currently it is required to be 1.
hasPrevBlock | char\[32\] | 32 | 256-bit hash of the previous block header
hashMerkleRoot | char\[32\] | 32 | 256-bit MerkleRoot based on the hashes of all the transactions in the block
hashImMerkleRoot | char\[32\] | 32 | 256-bit MerkleRoot based on Tapyrus transaction id -  [Malleability fixing transaction hash](doc/fix_transaction_malleability.md)
time | uint32_t | 4 | Current block timestamp as seconds since 1970-01-01T00:00 UTC
xfieldType| uint8_t | 1 | Type of xfield. See xfieldType table.
xfield| specified by xfieldType | variable | Extra field. This field can host any type of data defined in Tapyrus protocol.
Proof | char[64] | 65* | Threshold signature generated by tapyrus-signer to validate/approve this block. This fields is empty before the block is approved.

* *Additional 1 byte for length

**xfieldType**

Value | Name|Type|Size(Bytes)|Description
------|-----|----|-----------|------------
0x00 | None | N/A | 0 | set when xfield isn't used.
0x01 | AggregatePublicKey | char[33] | 34* | Aggregate public key of tapyrus-signer used to verify block proof.

* when xfieldType is not 0, xfield must contain length and value. length uses variable length "varint" encoding.

**Aggregate public key**
Tapyrus-core needs an aggregate public key to verify the threshold signature in blocks. 
It reads the aggregate public key from the *genesis block file* named `genesis.dat` found in the data directory. 
The aggregate public key is generated by tapyrus-signer network during network initialization. 
The process involves creation of genesis block using tapyrus-genesis utility and 
starting the tapyrus-signer network to *sign* the genesis block. 
Genesis Block header also has the aggregate public key in x_field. Thus the aggregated public key is embedded into the chain.

**Proof**
Proof is the Schnorr threshold signature generated by the tapyrus-signer network by aggregating the individual signatures of its federation members using a verifiable secret sharing scheme. Details about the scheme are available in [tapyrus-signer](https://github.com/chaintope/tapyrus-signer).

RPC collection for Signer Nodes
===============================

Tapyrus-Signer Nodes use the following RPCs to communicate with Tapyrus-Core.

## getnewblock

```
getnewblock

Gets hex representation of a proposed, unmined new block

Arguments:
1. address         (string, required) The address to send fees and the newly generated coin.
2. required_age    (numeric, optional, default=0) How many seconds a transaction must have been in the mempool to be inluded in the block proposal. This may help with faster block convergence among functionaries using compact blocks.

Result
blockhex      (hex) The block hex

Examples:
> tapyrus-cli getnewblock
```


## submitblock


```
submitblock "hexdata"  ( "dummy" )

Attempts to submit new block to network.
See https://en.bitcoin.it/wiki/BIP_0022 for full specification.

Arguments
1. "hexdata"        (string, required) the hex-encoded block data to submit
2. "dummy"          (optional) dummy value, for compatibility with BIP22. This value is ignored.

Result:

Examples:
> tapyrus-cli submitblock "mydata"
> curl --user myusername --data-binary '{"jsonrpc": "1.0", "id":"curltest", "method": "submitblock", "params": ["mydata"] }' -H 'content-type: text/plain;' http://127.0.0.1:2377/
```
